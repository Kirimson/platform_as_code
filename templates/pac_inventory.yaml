---
all:
  children:
    {%- for cluster in clusters %}
    {{ cluster.name }}:
      hosts:
        {%- for vm in vms[cluster.name] %}
        {{ vm.name }}:
          ansible_host: {{ vm.primary_ip.address.split('/')[0] }}
          {% for meta_key in vm.custom_fields.metadata -%}
          {{ meta_key }}: {{ vm.custom_fields.metadata[meta_key] }}
          {% endfor %}
        {%- endfor %}
      vars:
        ansible_user: deploy 
        ansible_ssh_private_key_file: /var/lib/rundeck/.ssh/id_rsa
        {% for meta_key in cluster.custom_fields.metadata -%}
        {{ meta_key }}: {{ cluster.custom_fields.metadata[meta_key] }}
        {% endfor %}
    {%- endfor %}